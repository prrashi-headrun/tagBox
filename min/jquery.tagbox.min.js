(function($){"use strict";if(String.prototype.trim!=="function"){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}var e={};var t=13,n=37,r=38,a=39,i=40,o=8,l=27,f=32;function s(){var e=window.getSelection();return e.anchorOffset}function u(e,t){var n=$(e).text().length;if(t==="start"){t=0}else if(t==="end"){t=n}var r=null;if(typeof window.getSelection!=="undefined"&&typeof document.createRange!=="undefined"){r=document.createRange();e=e.childNodes[0];if(!e){return}r.setStart(e,t);r.setEnd(e,n);r.collapse(true);var a=window.getSelection();a.removeAllRanges();a.addRange(r)}else if(typeof document.body.createTextRange!=="undefined"){r=document.body.createTextRange();r.moveToElementText(e);r.collapse(false);r.select()}}function c(e,t){e.siblings("span.tagbox-wg[contenteditable]").removeAttr("contenteditable");e.attr("contenteditable","true").focus();if(t!==undefined){u(e.get(0),t)}return e}function g(e){return e.replace(/\ /g,"&nbsp;")}function d(e,t,n){t=t||"";e.children("span.tagbox-wg").removeAttr("contenteditable");var r=$("<span/>").addClass("tagbox-wg")[n?"html":"text"](t).appendTo(e);t=g(t);r.html(t);return c(r)}function v(e){var t=e.prev();if(t.length===0){return e}else{while(e.prev(".tagbox-wg").length===0){e.prev().remove()}t=e.prev();var n=e.text(),r=t.text();c(t);if(n.length>0){t.text(r+n)}e.remove();u(t.get(0),r.length);return t}}function p(e,n){var a=n.autoFillData;var l=e.val().trim();var s=$("<div/>").addClass("tagbox-container").insertBefore(e);e.hide().appendTo(s);var p=$("<div/>").addClass("tagbox tagbox-input").prependTo(s);var h=l.split("\n"),b=h.length;var x=null;$.each(h,function(e,t){x=d(p,t);if(e<b-1){$("<br/>").insertAfter(x)}});var w=0;function m(e){var t=null;var n=$(e.target);if(n.hasClass("tagbox-wg")){x=c(n);t=window.getSelection();w=t.focusOffset}}var y=0;s.on("click",m).on("keyup","[contenteditable='true']",function(e){var t=e.which||e.keyCode;if(t!==r&&t!==i){var n=window.getSelection(),a=n.focusOffset;y=a}}).on("keydown","[contenteditable='true']",function(e){var n=e.which||e.keyCode;var a=window.getSelection(),l=a.focusOffset;var s=x.text();var h,b;if(n===t){e.preventDefault();var w=$("<br/>");if(l===0&&s.length!==0){w.insertBefore(x);d(p).insertBefore(w);c(x)}else{w.insertAfter(x);h=s.substr(0,l);b=s.substr(l);x.text(h);x=d(p,b);c(x.insertAfter(w))}}else if(n===o){if(x.text().length===0||l===0){e.preventDefault();x=v(x)}}else if(n===f){e.preventDefault();h=g(s.substr(0,l));b=g(s.substr(l));x.html(h+"&nbsp;"+b);u(x.get(0),l+1)}else if(n===r||n===i){e.preventDefault();var m=x.prevAll(".tagbox-wg").eq(0),A=x.nextAll(".tagbox-wg").eq(0),T=null;T=n===r?m:A;if(T.length===0){return}var S;if(T.text().length<y){S=T.text().length}else{S=y}x=c(T,S)}})}function h(t){t=$.extend(t,e);return $.each(this,function(e,n){var r=n.tagName;if(r==="TEXTAREA"||r==="INPUT"){p($(n),t)}})}$.fn.tagBox=h})(jQuery);