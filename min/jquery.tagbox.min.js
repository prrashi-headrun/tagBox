(function($){"use strict";if(String.prototype.trim!=="function"){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}var e={};var t=13,n=37,r=38,a=39,l=40,i=8,o=27,f=32,s=46;var u=17;var c=66,g=73,d=85;var v=[t,n,r,a,l,i,o,f,s,u,c,g,d];function b(){var e=window.getSelection();return e.anchorOffset}function p(e,t){var n=$(e).text().length;if(t==="start"){t=0}else if(t==="end"){t=n}var r=null;if(typeof window.getSelection!=="undefined"&&typeof document.createRange!=="undefined"){r=document.createRange();e=e.childNodes[0];if(!e){return}r.setStart(e,t);r.setEnd(e,n);r.collapse(true);var a=window.getSelection();a.removeAllRanges();a.addRange(r)}else if(typeof document.body.createTextRange!=="undefined"){r=document.body.createTextRange();r.moveToElementText(e);r.collapse(false);r.select()}}function h(e,t){e.siblings("[contenteditable]").removeAttr("contenteditable");e.attr("contenteditable","true").focus();if(t!==undefined){p(e.get(0),t)}return e}function x(e){return e.replace(/\ /g,"&nbsp;")}var w={bold:{"class":"tagbox-bold"},italic:{"class":"tagbox-italic"},underline:{"class":"tagbox-underline"},anchor:{"class":"tagbox-anchor"},label:{html:"tagbox-label"}};function m(e,t,n){n=n||"";n=x(n);e.blur().removeAttr("contenteditable");var r=$("<span/>").addClass("inner-tagbox-wg").addClass(w[t].class).attr("contenteditable","true").html(n).appendTo(e);return h(r)}function y(e,t){t=t||"";t=x(t);var n=$("<span/>").addClass("tagbox-wg").html(t).appendTo(e);return h(n)}function A(e){var t=e.prev();if(t.length===0){return e}else{while(e.prev(".tagbox-wg").length===0){e.prev().remove()}t=e.prev();var n=e.text(),r=t.text();h(t);if(n.length>0){t.text(r+n)}e.remove();p(t.get(0),r.length);return t}}function T(e,o){var u=o.autoFillData;var w=e.val().trim();var T=$("<div/>").addClass("tagbox-container").insertBefore(e);e.hide().appendTo(T);var D=$("<div/>").addClass("tagbox tagbox-input").prependTo(T);var S=w.split("\n"),C=S.length;var R=null;$.each(S,function(e,t){R=y(D,t);if(e<C-1){$("<br/>").insertAfter(R)}});var k=0;function B(e){var t=null;var n=$(e.target);if(n.hasClass("tagbox-wg")){R=h(n);t=window.getSelection();k=t.focusOffset}}function E(e){var o=e.which||e.keyCode;if($.inArray(o,v)<0){return}var u=window.getSelection(),w=u.focusOffset;var T=R.text();var S,C;if(e.ctrlKey&&o===c){e.preventDefault();R=m(R,"bold")}else if(e.ctrlKey&&o===d){e.preventDefault();R=m(R,"underline")}else if(e.ctrlKey&&o===g){e.preventDefault();R=m(R,"italic")}else if(o===t){e.preventDefault();var B=$("<br/>");if(w===0&&T.length!==0){B.insertBefore(R);y(D).insertBefore(B);h(R)}else{B.insertAfter(R);S=T.substr(0,w);C=T.substr(w);R.text(S);R=y(D,C);h(R.insertAfter(B))}}else if(o===i){if(T.length===0||w===0){e.preventDefault();R=A(R)}}else if(o===s){if(T.length===0||w===T.length){e.preventDefault();var E=R.nextAll(".tagbox-wg").eq(0);if(E.length>0){R=A(E)}}}else if(o===f){e.preventDefault();S=x(T.substr(0,w));C=x(T.substr(w));R.html(S+"&nbsp;"+C);p(R.get(0),w+1)}else if(o===r||o===l||o===n||o===a){var O=R.prevAll(".tagbox-wg").eq(0),E=R.nextAll(".tagbox-wg").eq(0),q=null;var K=b();if(o===r){q=O}else if(o===l){q=E}else if(o===n&&K===0){q=O}else if(o===a&&K===T.length){q=E}if(!q||q.length===0){return}e.preventDefault();var N=q.text();if(o===n){K=N.length}else if(o===a){K=0}else if(o===r||o===l){if(N.length<k){K=N.length}else{K=k}}R=h(q,K)}}function O(e){var t=e.which||e.keyCode;if(t!==r&&t!==l){var n=window.getSelection(),a=n.focusOffset;k=a}}T.on("click",B).on("keyup","[contenteditable='true']",O).on("keydown","[contenteditable='true']",E)}function D(t){t=$.extend(t,e);return $.each(this,function(e,n){var r=n.tagName;if(r==="TEXTAREA"||r==="INPUT"){T($(n),t)}})}$.fn.tagBox=D})(jQuery);