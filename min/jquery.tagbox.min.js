(function($){"use strict";if(String.prototype.trim!=="function"){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}var e={};var t=13,n=37,r=38,i=39,a=40,o=8,l=27,f=32;function s(){var e=window.getSelection();return e.anchorOffset}function u(e,t){var n=$(e).text().length;if(t==="start"){t=0}else if(t==="end"){t=n}var r=null;if(typeof window.getSelection!=="undefined"&&typeof document.createRange!=="undefined"){r=document.createRange();e=e.childNodes[0];if(!e){return}r.setStart(e,t);r.setEnd(e,n);r.collapse(true);var i=window.getSelection();i.removeAllRanges();i.addRange(r)}else if(typeof document.body.createTextRange!=="undefined"){r=document.body.createTextRange();r.moveToElementText(e);r.collapse(false);r.select()}}function c(e,t){e.siblings("span.tagbox-wg[contenteditable]").removeAttr("contenteditable");e.attr("contenteditable","true").focus();if(t!==undefined){u(e.get(0),t)}return e}function g(e){return e.replace(/\ /g,"&nbsp;")}function d(e,t,n){t=t||"";e.children("span.tagbox-wg").removeAttr("contenteditable");var r=$("<span/>").addClass("tagbox-wg")[n?"html":"text"](t).appendTo(e);t=g(t);r.html(t);return c(r)}function v(e){var t=e.prev();if(t.length===0){return e}else{while(e.prev(".tagbox-wg").length===0){e.prev().remove()}t=e.prev();var n=e.text(),r=t.text();c(t);if(n.length>0){t.text(r+n)}e.remove();u(t.get(0),r.length);return t}}function p(e,l){var p=l.autoFillData;var h=e.val().trim();var b=$("<div/>").addClass("tagbox-container").insertBefore(e);e.hide().appendTo(b);var x=$("<div/>").addClass("tagbox tagbox-input").prependTo(b);var w=h.split("\n"),m=w.length;var y=null;$.each(w,function(e,t){y=d(x,t);if(e<m-1){$("<br/>").insertAfter(y)}});var A=0;function T(e){var t=null;var n=$(e.target);if(n.hasClass("tagbox-wg")){y=c(n);t=window.getSelection();A=t.focusOffset}}var S=0;b.on("click",T).on("keyup","[contenteditable='true']",function(e){var t=e.which||e.keyCode;if(t!==r&&t!==a){var n=window.getSelection(),i=n.focusOffset;S=i}}).on("keydown","[contenteditable='true']",function(e){var l=e.which||e.keyCode;var p=window.getSelection(),h=p.focusOffset;var b=y.text();var w,m;if(l===t){e.preventDefault();var A=$("<br/>");if(h===0&&b.length!==0){A.insertBefore(y);d(x).insertBefore(A);c(y)}else{A.insertAfter(y);w=b.substr(0,h);m=b.substr(h);y.text(w);y=d(x,m);c(y.insertAfter(A))}}else if(l===o){if(y.text().length===0||h===0){e.preventDefault();y=v(y)}}else if(l===f){e.preventDefault();w=g(b.substr(0,h));m=g(b.substr(h));y.html(w+"&nbsp;"+m);u(y.get(0),h+1)}else if(l===r||l===a||l===n||l===i){var T=y.prevAll(".tagbox-wg").eq(0),R=y.nextAll(".tagbox-wg").eq(0),C=null;var k=s();if(l===r){C=T}else if(l===a){C=R}else if(l===n&&k===0){C=T}else if(l===i&&k===b.length){C=R}if(!C||C.length===0){return}e.preventDefault();var D=C.text();if(l===n){k=D.length}else if(l===i){k=0}else if(l===r||l===a){if(D.length<S){k=D.length}else{k=S}}y=c(C,k)}})}function h(t){t=$.extend(t,e);return $.each(this,function(e,n){var r=n.tagName;if(r==="TEXTAREA"||r==="INPUT"){p($(n),t)}})}$.fn.tagBox=h})(jQuery);